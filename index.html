<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>å¸­æ±ºã‚ãã˜å¼•ã</title>

<!-- PWA -->
<link rel="manifest" href="manifest.json">
<meta name="theme-color" content="#3498db">
<link rel="icon" href="icons/icon-192.png">

<style>
  body { font-family: sans-serif; text-align: center; padding: 20px; background: #f0f0f0; }
  h1 { color: #333; }
  input, button { padding: 10px; font-size: 18px; margin: 10px; }
  #numberDisplay { font-size: 56px; font-weight: bold; margin: 40px 0; color: #e74c3c; min-height: 1.2em; }
  #results { margin-top: 20px; font-size: 18px; }
  .btn { background: #3498db; color: white; border: none; border-radius: 6px; cursor: pointer; }
  .btn:disabled { opacity: 0.5; cursor: not-allowed; }
  #status { margin-top: 16px; font-size: 16px; color: #2c3e50; min-height: 1.2em; }
  .row { display:flex; gap:8px; justify-content:center; flex-wrap:wrap; }
</style>
</head>
<body>

<h1>å¸­æ±ºã‚ãã˜å¼•ã</h1>

<div class="row">
  <input type="number" id="count" placeholder="äººæ•°ã‚’å…¥åŠ›" min="1" inputmode="numeric">
  <button class="btn" id="startBtn">ã‚¹ã‚¿ãƒ¼ãƒˆ</button>
  <button class="btn" id="stopBtn" style="display:none;">ã‚¹ãƒˆãƒƒãƒ—ï¼</button>
  <button class="btn" id="resetBtn">ãƒªã‚»ãƒƒãƒˆ</button>
  <button class="btn" id="muteBtn" aria-pressed="false">ğŸ”Š ãƒŸãƒ¥ãƒ¼ãƒˆ</button>
</div>

<div id="numberDisplay">---</div>
<div id="status"></div>
<div id="results"></div>

<!-- ãƒ‰ãƒ©ãƒ ãƒ­ãƒ¼ãƒ«éŸ³ï¼ˆãƒ¦ãƒ¼ã‚¶ãƒ¼æ“ä½œã§å†ç”Ÿé–‹å§‹ã€‚iOSå¯¾ç­–ã§controlsã¯éè¡¨ç¤ºï¼‰ -->
<!-- éŸ³å£°ãƒ•ã‚¡ã‚¤ãƒ«è¿½åŠ  -->
<audio id="drum" src="sounds/drumroll.mp3" preload="auto" loop></audio>
<audio id="fanfare" src="sounds/fanfare.mp3" preload="auto"></audio>

<script>
let seats = [];
let intervalId = null;
let currentNumber = null;
let finished = false;
let muted = false;

const startBtn = document.getElementById('startBtn');
const stopBtn  = document.getElementById('stopBtn');
const resetBtn = document.getElementById('resetBtn');
const muteBtn  = document.getElementById('muteBtn');
const numberDisplay = document.getElementById('numberDisplay');
const resultsDiv = document.getElementById('results');
const statusDiv = document.getElementById('status');
const drum = document.getElementById('drum');
const fanfare = document.getElementById('fanfare');

function stopDraw() {
  if (!intervalId) return;

  clearInterval(intervalId);
  intervalId = null;

  // ãƒ‰ãƒ©ãƒ ãƒ­ãƒ¼ãƒ«åœæ­¢
  drum.pause();

  // å½“é¸ç•ªå·ã‚’ãƒªã‚¹ãƒˆã‹ã‚‰é™¤å¤–
  seats = seats.filter(num => num !== currentNumber);

  // çµæœè¡¨ç¤º
  resultsDiv.innerHTML += `<div>â†’ å¸­ç•ªå· ${currentNumber} æ±ºå®šï¼</div>`;

  // ãƒ•ã‚¡ãƒ³ãƒ•ã‚¡ãƒ¼ãƒ¬å†ç”Ÿ
  if (!muted) {
    fanfare.currentTime = 0;
    fanfare.play().catch(()=>{});
  }

  stopBtn.style.display = 'none';
  startBtn.disabled = false;
  resetBtn.disabled = false;
  numberDisplay.textContent = '---';

  // ã™ã¹ã¦å‡ºãŸã‚‰çµ‚äº†è¡¨ç¤º
  if (seats.length === 0) {
    finished = true;
    startBtn.disabled = true;
    stopBtn.disabled = true;
    updateStatus();
    return;
  }
  updateStatus();
}


function updateStatus() {
  if (finished) {
    statusDiv.textContent = 'ãƒ«ãƒ¼ãƒ¬ãƒƒãƒˆãŒçµ‚äº†ã—ã¾ã—ãŸ';
  } else if (seats.length > 0) {
    statusDiv.textContent = `æ®‹ã‚Š ${seats.length} / åˆè¨ˆ ${totalCount}`;
  } else {
    statusDiv.textContent = '';
  }
}

let totalCount = 0;

function initSeats(count) {
  totalCount = count;
  seats = Array.from({length: count}, (_, i) => i + 1);
  finished = false;
  resultsDiv.innerHTML = '';
  numberDisplay.textContent = '---';
  updateStatus();
}

function startDraw() {
  const countInput = parseInt(document.getElementById('count').value);
  if (!seats.length && !finished) {
    if (!countInput || countInput <= 0) {
      alert('äººæ•°ã‚’æ­£ã—ãå…¥åŠ›ã—ã¦ãã ã•ã„');
      return;
    }
    initSeats(countInput);
  }

  if (finished) return;

  stopBtn.style.display = 'inline-block';
  startBtn.disabled = true;
  resetBtn.disabled = true;

  // ãƒ‰ãƒ©ãƒ ãƒ­ãƒ¼ãƒ«å†ç”Ÿï¼ˆãƒ¦ãƒ¼ã‚¶ãƒ¼æ“ä½œã‚¤ãƒ™ãƒ³ãƒˆå†…ãªã®ã§å†ç”Ÿå¯èƒ½ï¼‰
  if (!muted) {
    drum.currentTime = 0;
    drum.play().catch(()=>{ /* å†ç”Ÿå¤±æ•—ã¯æ¡ã‚Šã¤ã¶ã™ */ });
  }

  intervalId = setInterval(() => {
    currentNumber = seats[Math.floor(Math.random() * seats.length)];
    numberDisplay.textContent = currentNumber;
  }, 50);
}

function stopDraw() {
  if (!intervalId) return;

  clearInterval(intervalId);
  intervalId = null;

  // ãƒ‰ãƒ©ãƒ ãƒ­ãƒ¼ãƒ«åœæ­¢
  drum.pause();

  // å½“é¸ç•ªå·ã‚’ãƒªã‚¹ãƒˆã‹ã‚‰é™¤å¤–
  seats = seats.filter(num => num !== currentNumber);

  // çµæœè¡¨ç¤º
  resultsDiv.innerHTML += `<div>â†’ å¸­ç•ªå· ${currentNumber} æ±ºå®šï¼</div>`;

  stopBtn.style.display = 'none';
  startBtn.disabled = false;
  resetBtn.disabled = false;
  numberDisplay.textContent = '---';

  // ã™ã¹ã¦å‡ºãŸã‚‰çµ‚äº†è¡¨ç¤ºï¼†æ“ä½œåˆ¶å¾¡
  if (seats.length === 0) {
    finished = true;
    startBtn.disabled = true;
    stopBtn.disabled = true;
    updateStatus();
    return;
  }
  updateStatus();
}

function resetAll() {
  clearInterval(intervalId);
  intervalId = null;
  drum.pause();
  seats = [];
  currentNumber = null;
  finished = false;
  numberDisplay.textContent = '---';
  resultsDiv.innerHTML = '';
  startBtn.disabled = false;
  stopBtn.disabled = false;
  stopBtn.style.display = 'none';
  updateStatus();
}

function toggleMute() {
  muted = !muted;
  muteBtn.textContent = muted ? 'ğŸ”‡ ãƒŸãƒ¥ãƒ¼ãƒˆè§£é™¤' : 'ğŸ”Š ãƒŸãƒ¥ãƒ¼ãƒˆ';
  muteBtn.setAttribute('aria-pressed', String(muted));
  if (muted) drum.pause();
}

// ã‚¤ãƒ™ãƒ³ãƒˆç´ä»˜ã‘
startBtn.addEventListener('click', startDraw);
stopBtn.addEventListener('click', stopDraw);
resetBtn.addEventListener('click', resetAll);
muteBtn.addEventListener('click', toggleMute);

// PWA Service Workerç™»éŒ²
if ('serviceWorker' in navigator) {
  navigator.serviceWorker.register('service-worker.js')
    .then(() => console.log('Service Worker registered'));
}
</script>
</body>
</html>
