<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8" />
<meta name="viewport"
      content="width=device-width, initial-scale=1, viewport-fit=cover, maximum-scale=1, user-scalable=no" />
<title>å¸­æ±ºã‚ãã˜å¼•ã</title>

<!-- PWA -->
<link rel="manifest" href="manifest.json?v=20" />
<meta name="theme-color" content="#ffffff" />
<link rel="icon" href="icons/icon-192.png" />

<style>
  /* ===== Pastel Pop Tokens ===== */
  :root{
    --bg: #fff;
    --ink: #334155;
    --muted:#64748b;
    --surface:#ffffffcc;
    --border:#e2e8f0;
    --shadow: 0 10px 30px rgba(2, 6, 23, .08);

    --p-rose:   #fecdd3;
    --p-pink:   #fbcfe8;
    --p-violet: #ddd6fe;
    --p-sky:    #bae6fd;
    --p-mint:   #bbf7d0;
    --p-amber:  #fde68a;

    --btn-grad:   linear-gradient(135deg, #a5b4fc, #93c5fd);
    --btn-grad-2: linear-gradient(135deg, #fbcfe8, #fde68a);
    --accent:   #fb7185;

    --seat-free: #ffffff;         /* ç©ºå¸­ èƒŒæ™¯ */
    --seat-free-bd: #e2e8f0;      /* ç©ºå¸­ æ ç·š */
    --seat-free-tag: #94a3b8;     /* ç©ºå¸­ ç•ªå·è‰² */
    --seat-taken: #bbf7d0;        /* ç¢ºå®š èƒŒæ™¯ï¼ˆãƒŸãƒ³ãƒˆï¼‰ */
    --seat-taken-bd: #34d399;     /* ç¢ºå®š æ ç·š */
    --seat-taken-tag:#065f46;     /* ç¢ºå®š ç•ªå·è‰² */
  }
  *{ box-sizing: border-box; }
  html,body{ height:100%; }
  body{
    margin:0; color:var(--ink);
    font:16px/1.6 system-ui, -apple-system, "Segoe UI", Roboto, "Hiragino Kaku Gothic ProN", "Noto Sans JP", sans-serif;
    background:
      radial-gradient(600px 600px at 10% -10%, var(--p-rose), transparent 60%),
      radial-gradient(500px 500px at 95% 0%, var(--p-sky), transparent 55%),
      radial-gradient(400px 400px at 10% 100%, var(--p-mint), transparent 55%),
      radial-gradient(360px 360px at 95% 100%, var(--p-violet), transparent 55%),
      #fff;
    padding:12px 10px 64px;
  }

  .app{ width:min(980px,96vw); margin:0 auto; display:grid; gap:12px; }

  /* ===== Hero ===== */
  .hero{
    position:relative; border:1px solid var(--border); background:var(--surface);
    border-radius:18px; box-shadow:var(--shadow); padding:12px 14px; overflow:hidden;
  }
  .dots{
    position:absolute; inset:-40px; pointer-events:none; opacity:.7;
    background:
      radial-gradient(90px 90px at 8% 12%, var(--p-rose), transparent 70%),
      radial-gradient(120px 120px at 90% 20%, var(--p-amber), transparent 70%),
      radial-gradient(110px 110px at 15% 90%, var(--p-mint), transparent 70%),
      radial-gradient(100px 100px at 92% 90%, var(--p-violet), transparent 70%);
  }
  .title{ position:relative; display:flex; align-items:center; gap:10px; }
  .logo{
    width:44px; height:44px; border-radius:12px; display:grid; place-items:center;
    background: var(--btn-grad);
    box-shadow: 0 8px 24px rgba(99, 102, 241, .25);
    font-size:20px;
  }
  h1{ margin:0; font-size: clamp(18px, 2.6vw, 26px); letter-spacing:.02em; }
  .subtitle{ color:var(--muted); font-size:12px; }

  /* ===== BIG CTA bar (Start/Stop only) ===== */
  .cta-bar{
    position: sticky; top: env(safe-area-inset-top, 0);
    z-index: 5;
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 10px;
  }
  .cta{
    border:0; border-radius:16px; padding:16px 14px; cursor:pointer;
    font-weight:900; letter-spacing:.02em; color:#0b1220;
    box-shadow: 0 10px 24px rgba(14, 165, 233, .20);
    background: var(--btn-grad); transition: transform .07s ease, filter .15s ease;
    font-size: clamp(18px, 4.8vw, 22px);
  }
  .cta.warn{
    background: linear-gradient(135deg, #fda4af, #fb7185);
    color:#fff; box-shadow:0 10px 24px rgba(251, 113, 133, .25);
  }
  .cta:active{ transform: translateY(1px); }
  .cta[disabled]{ opacity:.5; cursor:not-allowed; }

  /* ===== Secondary controls ===== */
  .card{
    border:1px solid var(--border); background:var(--surface);
    border-radius:16px; padding:12px; box-shadow:var(--shadow);
  }
  .row{ display:flex; gap:10px; flex-wrap:wrap; align-items:center; }
  label{ font-size:14px; color:var(--muted); }

  select{
    background:#fff; border:1px solid var(--border); color:var(--ink);
    border-radius:12px; padding:10px 12px; font-size:16px; outline:none;
    transition: box-shadow .15s, border-color .15s;
    min-width: 120px;
  }
  select:focus{
    border-color:#c7d2fe; box-shadow:0 0 0 3px rgba(199,210,254,.6);
  }
  .btn{
    border:0; border-radius:12px; padding:10px 12px; cursor:pointer;
    font-weight:800; letter-spacing:.02em; color:#0b1220;
    box-shadow: 0 6px 16px rgba(14, 165, 233, .16);
    background: var(--btn-grad-2); transition: transform .07s ease, filter .15s ease;
  }
  .btn.ghost{ background:#fff; color:var(--ink); border:1px solid var(--border); box-shadow:none; }
  .btn:active{ transform: translateY(1px); }
  .btn[disabled]{ opacity:.5; cursor:not-allowed; }

  /* ===== Display ===== */
  .display{ display:grid; gap:10px; text-align:center; }
  #numberDisplay{
    font-size: clamp(44px, 12vw, 96px); font-weight:900; letter-spacing:.03em;
    color: var(--accent);
    text-shadow: 0 10px 28px rgba(251, 113, 133, .28);
    min-height:1.2em;
  }
  #status{ color:var(--muted); min-height:1.2em; font-size: 14px; }

  /* ===== Seat Map ===== */
  .seat-map.card{ padding: 14px; }
  .seat-legend{ font-size:12px; color:var(--muted); display:flex; gap:10px; flex-wrap:wrap; margin-bottom:8px; }
  .legend-item{ display:flex; gap:6px; align-items:center; }
  .legend-swatch{ width:18px; height:12px; border-radius:4px; border:1px solid var(--border); }
  .legend-free { background: var(--seat-free); }
  .legend-taken{ background: var(--seat-taken); border-color: var(--seat-taken-bd); }

  .seat-grid{
    --cols: 5; /* ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã¯5åˆ—ã€‚JSã§ä¸Šæ›¸ãã—ã¾ã™ */
    display: grid;
    grid-template-columns: repeat(var(--cols), minmax(40px, 1fr));
    gap: 10px;
  }
  .seat{
    background: var(--seat-free);
    border: 1px solid var(--seat-free-bd);
    border-radius: 12px;
    padding: 6px 6px 8px;
    min-height: 54px;
    box-shadow: 0 6px 14px rgba(2,6,23,.06);
    display: grid;
    grid-template-rows: auto 1fr;
    align-items: start;
    justify-items: center;
    text-align: center;
  }
  .seat .no{
    font-weight: 900; font-size: 14px; color: var(--seat-free-tag);
  }
  .seat .name{
    font-weight: 800; font-size: 12px; color: #0f172a; word-break: break-word;
  }
  .seat.is-aisle{
    background: transparent; border: 1px dashed #e5e7eb; opacity:.5;
  }
  .seat.is-taken{
    background: var(--seat-taken);
    border-color: var(--seat-taken-bd);
  }
  .seat.is-taken .no{ color: var(--seat-taken-tag); }
  .seat.is-taken .name{ color: #064e3b; }

  .chips{ display:flex; flex-wrap:wrap; gap:8px; justify-content:center; }
  .chip{ padding:6px 10px; border-radius:999px; font-weight:800; font-size:14px; border:1px solid var(--border); background:#fff; }
  .chip--rose{ background:var(--p-rose); }
  .chip--pink{ background:var(--p-pink); }
  .chip--violet{ background:var(--p-violet); }
  .chip--sky{ background:var(--p-sky); }
  .chip--mint{ background:var(--p-mint); }
  .chip--amber{ background:var(--p-amber); }

  #results{ display:grid; gap:8px; }
  .result-item{
    background:#fff; border:1px solid var(--border); border-radius:14px;
    padding:10px 12px; box-shadow: var(--shadow); font-size: 15px;
  }

  /* ===== Overlaysï¼ˆè¦–èªæ€§UPï¼‰ ===== */
  #revealOverlay, #luckyOverlay{
    position:fixed; inset:0; display:none; place-items:center;
    background: rgba(0,0,0,.62);
    backdrop-filter: blur(3px);
    z-index:60;
  }
  .reveal-card, .lucky-card{
    background:#fff; border: 2px solid #e5e7eb; color:#111827; border-radius:18px;
    box-shadow: 0 24px 70px rgba(0,0,0,.35);
    padding:18px 22px; max-width:min(92vw,720px); text-align:center;
    animation: pop .26s ease-out;
  }
  @keyframes pop{ from{ transform:scale(.9); opacity:0 } to{ transform:scale(1); opacity:1 } }
  .reveal-title{ font-size:clamp(16px, 4vw, 18px); color:#475569; font-weight:700; }
  .reveal-number{
    font-size: clamp(74px, 18vw, 140px); line-height:1; font-weight:900;
    color:#ef4444; text-shadow:0 12px 30px rgba(239, 68, 68, .35);
  }
  .reveal-sub{ font-size:13px; color:#64748b; }

  .lucky-title{ font-size:clamp(20px,5vw,26px); font-weight:900; color:#92400e; margin-bottom:10px; }
  .seat-list{ font-size:14px; color:#475569; }
  .seat-grid-overlay{ display:grid; gap:10px; grid-template-columns:repeat(auto-fill, minmax(64px,1fr)); margin-top:12px; }
  .seat-btn{
    padding:10px 0; border-radius:12px; border:1px solid #facc15;
    background: linear-gradient(180deg, #fff7ed, #fffbeb);
    color:#92400e; font-weight:900; cursor:pointer;
    transition: transform .06s ease;
    box-shadow:0 10px 24px rgba(245,158,11,.18);
  }
  .seat-btn:active{ transform: translateY(1px); }

  /* Confetti */
  #confettiCanvas{ position:fixed; inset:0; z-index:55; pointer-events:none; display:none; }

  /* ===== iPhone SE / å°ç”»é¢èª¿æ•´ ===== */
  @media (max-width: 360px){
    body{ padding:10px 8px 54px; }
    .card{ padding:10px; border-radius:14px; }
    .hero{ padding:10px 12px; border-radius:14px; }
    .logo{ width:40px; height:40px; font-size:18px; }
    .cta{ padding:14px 10px; border-radius:14px; }
    .row{ gap:8px; }
    #results .result-item{ font-size:14px; }
    .seat-grid{ gap:8px; }
    .seat{ min-height: 50px; padding:6px; }
  }
</style>
</head>
<body>
  <div class="app">
    <section class="hero">
      <div class="dots"></div>
      <div class="title">
        <div class="logo">ğŸª‘</div>
        <div>
          <h1>å¸­æ±ºã‚ãã˜å¼•ã</h1>
          <div class="subtitle">å¸­ã®å½¢ã‚’ãã®ã¾ã¾ç”»é¢ã§å¯è¦–åŒ–ã€‚ç¢ºå®šã™ã‚‹ã¨è‰²ã¨åå‰ã§ãƒ‘ãƒƒã¨ã‚ã‹ã‚‹ï¼</div>
        </div>
      </div>
    </section>

    <!-- BIG CTA: Start / Stop ã ã‘ã‚’å¤§ãã -->
    <section class="cta-bar">
      <button class="cta" id="startBtn">ã‚¹ã‚¿ãƒ¼ãƒˆ</button>
      <button class="cta warn" id="stopBtn" style="display:none;">ã‚¹ãƒˆãƒƒãƒ—ï¼</button>
    </section>

    <!-- ã‚»ã‚«ãƒ³ãƒ€ãƒªæ“ä½œ -->
    <section class="card">
      <div class="row">
        <label for="currentName">ä»Šå›å›ã™äºº</label>
        <select id="currentName" aria-label="å‚åŠ è€…ã‚’é¸æŠ"></select>

        <button class="btn" id="resetBtn">ãƒªã‚»ãƒƒãƒˆ</button>
        <button class="btn ghost" id="muteBtn" aria-pressed="false" title="åŠ¹æœéŸ³ãƒŸãƒ¥ãƒ¼ãƒˆ">ğŸ”Š ã‚µã‚¦ãƒ³ãƒ‰</button>
        <button class="btn ghost" id="updateBtn" title="PWAæ›´æ–°">ğŸ”„ æ›´æ–°</button>
      </div>

      <div class="row" style="color:var(--muted); font-size:13px;">
        <span>ãƒ©ãƒƒã‚­ãƒ¼æŠ½é¸ã®ç¢ºç‡</span>
        <input type="number" id="luckyProb" step="0.001" min="0" max="1" placeholder="æœªè¨­å®šãªã‚‰ 1/å¸­æ•°" style="width:8.5em;" />
        <span>ï¼ˆ0ã€œ1ã€ä¾‹ï¼š0.1ã§10%ï¼‰</span>
      </div>
    </section>

    <!-- åº§å¸­ãƒãƒƒãƒ—ï¼ˆãƒ¬ã‚¤ã‚¢ã‚¦ãƒˆæº–æ‹ ï¼‰ -->
    <section class="seat-map card">
      <div class="seat-legend">
        <span class="legend-item"><span class="legend-swatch legend-free"></span>ç©ºå¸­</span>
        <span class="legend-item"><span class="legend-swatch legend-taken"></span>ç¢ºå®šæ¸ˆã¿</span>
      </div>
      <div id="seatGrid" class="seat-grid" aria-label="åº§å¸­ãƒãƒƒãƒ—ï¼ˆç•ªå·ã¯å›ºå®šï¼‰"></div>
    </section>

    <!-- æ•°å­—è¡¨ç¤ºã‚„ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ -->
    <section class="card display" aria-live="polite">
      <div id="numberDisplay">---</div>
      <div id="status"></div>
      <div class="chips" id="chips"></div>
    </section>

    <section class="card">
      <div id="results" aria-label="çµæœä¸€è¦§"></div>
    </section>
  </div>

  <!-- åŠ¹æœéŸ³ -->
  <audio id="drum" src="sounds/drumroll.mp3?v=20" preload="auto" loop></audio>
  <audio id="fanfare" src="sounds/fanfare.mp3?v=20" preload="auto"></audio>

  <!-- ç´™å¹é›ªï¼†å½“é¸ã‚ªãƒ¼ãƒãƒ¼ãƒ¬ã‚¤ -->
  <canvas id="confettiCanvas"></canvas>

  <div id="revealOverlay" aria-hidden="true">
    <div class="reveal-card">
      <div id="revealTitle" class="reveal-title">å½“é¸å¸­ç•ªå·</div>
      <div id="revealNumber" class="reveal-number">--</div>
      <div class="reveal-sub">ã‚¿ãƒƒãƒ—ã§é–‰ã˜ã‚‹</div>
    </div>
  </div>

  <!-- ãƒ©ãƒƒã‚­ãƒ¼ï¼ˆå¥½ããªå¸­ã‚’é¸ã¹ã‚‹ï¼‰ -->
  <div id="luckyOverlay" aria-hidden="true">
    <div class="lucky-card">
      <div id="luckyTitle" class="lucky-title">âœ¨ ãƒ©ãƒƒã‚­ãƒ¼ï¼å¥½ããªå¸­ã‚’é¸ã¶ã“ã¨ãŒã§ãã¾ã™ï¼ âœ¨</div>
      <div class="seat-list">æ®‹ã£ã¦ã„ã‚‹å¸­ã‹ã‚‰1ã¤é¸ã‚“ã§ãã ã•ã„ã€‚</div>
      <div id="seatGridOverlay" class="seat-grid-overlay" style="margin-top:10px"></div>
      <div style="margin-top:10px; font-size:12px; color:#6b7280;">â€»ã‚¿ãƒƒãƒ—ã™ã‚‹ã¨ç¢ºå®šã—ã¾ã™</div>
    </div>
  </div>

<script>
/* ===== å›ºå®šåç°¿ï¼ˆã“ã“ã‚’æ›¸ãæ›ãˆï¼‰ ===== */
const PRESET_NAMES = [
  "ç”°ä¸­", "ä½è—¤", "éˆ´æœ¨", "é«˜æ©‹", "ä¼Šè—¤",
  "æ¸¡è¾º", "å±±æœ¬", "ä¸­æ‘", "å°æ—", "åŠ è—¤"
];

/* ===== å›ºå®šãƒ¬ã‚¤ã‚¢ã‚¦ãƒˆï¼ˆnull ã¯é€šè·¯ãƒ»ç©ºç™½ï¼‰ =====
  ä¾‹ï¼‰5åˆ—Ã—3è¡Œã€‚è‡ªç”±ã«å½¢ã‚’ä½œã‚Œã¾ã™ï¼ˆåˆ—æ•°ã¯è¡Œã”ã¨ã«åˆã‚ã›ã‚‹ï¼‰ã€‚
  å¸­ç•ªå·ã¯ â€œè¡¨ç¤ºç”¨ & æŠ½é¸å¯¾è±¡â€ ã«ãªã‚Šã¾ã™ã€‚*/
const SEAT_LAYOUT = [
  [ null,  1,   2,   3,   4,   5, null ],
  [ null,  6,   7,   8,   9,   10, null ],
  [ null,  null,   null,   null,   null ],
  [ null,  11,   12,   13,   14,   15, null ],
  [ null,  16,   17,   18,   19,   20,   21,  null ],
  [ null,  null,   null,   null,   null ],
  [ null,  22,   23,   24,   25,   26, null ],
  [ null,  27,   28,   29,   30,   31, null ],
  
  // ä¾‹ï¼šé…åˆ—ã‚’å¢—ã‚„ã›ã°è¡Œã‚’è¿½åŠ ã§ãã¾ã™
];

/* ===== å‚ç…§ ===== */
let names = [...PRESET_NAMES];
let assigned = new Set();                  // æ±ºå®šæ¸ˆã¿ã®å‚åŠ è€…å
const startBtn = document.getElementById('startBtn');
const stopBtn  = document.getElementById('stopBtn');
const resetBtn = document.getElementById('resetBtn');
const muteBtn  = document.getElementById('muteBtn');
const updateBtn= document.getElementById('updateBtn');
const currentNameSel = document.getElementById('currentName');

const numberDisplay = document.getElementById('numberDisplay');
const statusDiv = document.getElementById('status');
const chipsDiv = document.getElementById('chips');
const resultsDiv = document.getElementById('results');

const drum = document.getElementById('drum');
const fanfare = document.getElementById('fanfare');
const luckyProbInput = document.getElementById('luckyProb');

const confettiCanvas = document.getElementById('confettiCanvas');
const ctx = confettiCanvas.getContext('2d');

const revealOverlay = document.getElementById('revealOverlay');
const revealTitleEl = document.getElementById('revealTitle');
const revealNumberEl = document.getElementById('revealNumber');

const luckyOverlay = document.getElementById('luckyOverlay');
const luckyTitle = document.getElementById('luckyTitle');
const seatGridOverlay = document.getElementById('seatGridOverlay');

const seatGrid = document.getElementById('seatGrid');

/* ===== çŠ¶æ…‹ ===== */
let seats = [];                     // æœªç¢ºå®šã®å¸­ç•ªå·ãƒªã‚¹ãƒˆ
let intervalId = null;
let currentNumber = null;
let finished = false;
let muted = false;
let totalCount = 0;
let initialCount = 0;
let currentPlayer = null;

const seatCellByNo = new Map();     // seatNo -> HTMLElement
const seatNameByNo = new Map();     // seatNo -> assigned name

/* ===== ãƒ¬ã‚¤ã‚¢ã‚¦ãƒˆåˆæœŸåŒ– ===== */
function getAllSeatNumbers(){
  const nums = [];
  for (const row of SEAT_LAYOUT) for (const v of row) if (typeof v === 'number') nums.push(v);
  return nums;
}
function maxCols(){
  return Math.max(...SEAT_LAYOUT.map(r => r.length));
}
function renderSeatMap(){
  // åˆ—æ•°ã‚’CSSå¤‰æ•°ã§æ¸¡ã™
  seatGrid.style.setProperty('--cols', String(maxCols()));
  seatGrid.innerHTML = '';
  seatCellByNo.clear();

  for (const row of SEAT_LAYOUT){
    for (let i=0; i<maxCols(); i++){
      const v = row[i] ?? null;
      const cell = document.createElement('div');
      cell.className = 'seat';
      if (v === null){
        cell.classList.add('is-aisle');
        cell.innerHTML = `<div class="no">â€”</div>`;
      } else {
        cell.dataset.no = String(v);
        cell.innerHTML = `<div class="no">${v}</div><div class="name"></div>`;
        seatCellByNo.set(v, cell);
      }
      seatGrid.appendChild(cell);
    }
  }
}

/* ===== åç°¿ ===== */
function populateNameSelect() {
  const remaining = names.filter(n => !assigned.has(n));
  currentNameSel.innerHTML = '';
  if (!remaining.length) {
    const opt = document.createElement('option'); opt.value=''; opt.text='ï¼ˆå…¨å“¡æ±ºå®šæ¸ˆã¿ï¼‰';
    currentNameSel.appendChild(opt); return;
  }
  remaining.forEach(n => {
    const opt = document.createElement('option'); opt.value=n; opt.text=n;
    currentNameSel.appendChild(opt);
  });
}

/* ===== ç´™å¹é›ª ===== */
function resizeCanvas(){ confettiCanvas.width = innerWidth; confettiCanvas.height = innerHeight; }
addEventListener('resize', resizeCanvas); resizeCanvas();
let confetti = []; let confettiRunning = false;
function launchConfetti(duration=1600, count=260, gold=false){
  confetti = [];
  const w = confettiCanvas.width, h = confettiCanvas.height;
  for(let i=0;i<count;i++){
    const hue = gold ? (45 + Math.random()*30) : Math.floor(Math.random()*360);
    confetti.push({ x:Math.random()*w, y:-20 - Math.random()*h*0.4, r:4+Math.random()*6, vx:-1+Math.random()*2, vy:2+Math.random()*3,
      rot:Math.random()*Math.PI*2, vr:-0.3+Math.random()*0.6, color: gold ? `hsl(${hue},90%,55%)` : `hsl(${hue},85%,55%)` });
  }
  const start = performance.now(); confettiCanvas.style.display='block'; confettiRunning=true;
  function tick(now){
    const t = now - start;
    ctx.clearRect(0,0,w,h);
    confetti.forEach(p=>{ p.x+=p.vx; p.y+=p.vy; p.rot+=p.vr; p.vy+=0.02;
      ctx.save(); ctx.translate(p.x,p.y); ctx.rotate(p.rot); ctx.fillStyle=p.color; ctx.fillRect(-p.r,-p.r*0.6,p.r*2,p.r*1.2); ctx.restore(); });
    if (t<duration) requestAnimationFrame(tick); else { confettiRunning=false; confettiCanvas.style.display='none'; }
  }
  requestAnimationFrame(tick);
}

/* ===== è¡¨ç¤º ===== */
function renderChips() {
  const classes = ['chip--rose','chip--pink','chip--violet','chip--sky','chip--mint','chip--amber'];
  chipsDiv.innerHTML = seats.map((n,i) => `<span class="chip ${classes[i%classes.length]}">${n}</span>`).join('');
}
function updateStatus(){
  const remainingSeats = seats.length;
  const remainingPeople = names.filter(n=>!assigned.has(n)).length;
  statusDiv.textContent = finished ? 'ãƒ«ãƒ¼ãƒ¬ãƒƒãƒˆãŒçµ‚äº†ã—ã¾ã—ãŸ' : `æ®‹ã‚Šåº§å¸­ ${remainingSeats} / åˆè¨ˆ ${totalCount}ã€€|ã€€æœªæ±ºå®šã®äºº ${remainingPeople}`;
  renderChips();
}

/* ===== åˆæœŸåŒ– ===== */
function initFromLayout(){
  const nums = getAllSeatNumbers();
  seats = [...nums];                 // æœªç¢ºå®šå¸­
  totalCount = nums.length;
  initialCount = nums.length;
  finished = false;
  resultsDiv.innerHTML = '';
  numberDisplay.textContent = '---';
  seatNameByNo.clear();
  for (const [no, el] of seatCellByNo.entries()){
    el.classList.remove('is-taken');
    el.querySelector('.name').textContent = '';
  }
  updateStatus();
}

/* ===== ãƒ©ãƒƒã‚­ãƒ¼åˆ¤å®š ===== */
function isLuckyHit(){
  const input = parseFloat(luckyProbInput.value);
  const p = (!isNaN(input) && input>=0 && input<=1) ? input : (initialCount>0 ? (1/initialCount) : 0.1);
  return Math.random() < p;
}

/* ===== ã‚¹ã‚¿ãƒ¼ãƒˆï¼ã‚¹ãƒˆãƒƒãƒ—ï¼ˆå¤§ãƒœã‚¿ãƒ³ï¼‰ ===== */
function startDraw(){
  const sel = currentNameSel.value;
  if (!sel) { alert('ä»Šå›å›ã™äººã‚’é¸ã‚“ã§ãã ã•ã„'); return; }
  if (assigned.has(sel)) { alert('ãã®æ–¹ã¯ã™ã§ã«æ±ºå®šæ¸ˆã¿ã§ã™ã€‚åˆ¥ã®æ–¹ã‚’é¸ã‚“ã§ãã ã•ã„ã€‚'); return; }
  currentPlayer = sel;

  if (!seats.length && !finished) {
    initFromLayout();  // ãƒ¬ã‚¤ã‚¢ã‚¦ãƒˆã«å¾“ã£ã¦åˆæœŸåŒ–
  }
  if (finished) return;

  stopBtn.style.display='block'; startBtn.disabled=true; startBtn.style.opacity=.6; resetBtn.disabled=true; currentNameSel.disabled=true;

  if (!muted) { try { drum.currentTime=0; drum.play(); } catch(e){} }

  intervalId = setInterval(()=>{
    currentNumber = seats[Math.floor(Math.random() * seats.length)];
    numberDisplay.textContent = currentNumber;
  }, 50);
}

function stopDraw(){
  if (!intervalId) return;
  clearInterval(intervalId); intervalId=null; drum.pause();

  if (!currentPlayer) currentPlayer = currentNameSel.value || 'ï¼ˆåç„¡ã—ï¼‰';

  // ãƒ©ãƒƒã‚­ãƒ¼
  if (seats.length>1 && isLuckyHit()) { showLuckyOverlay(); return; }

  // é€šå¸¸å½“é¸
  seats = seats.filter(n=> n!==currentNumber);
  revealTitleEl.textContent = `${currentPlayer} ã•ã‚“ã¯â€¦`;
  revealNumberEl.textContent = currentNumber;
  revealOverlay.style.display='grid';
  if (!muted) { try { fanfare.currentTime=0; fanfare.play(); } catch(e){} }
  if (!confettiRunning) launchConfetti(1600, 260, false);
}

/* ===== ãƒ©ãƒƒã‚­ãƒ¼å‡¦ç† ===== */
function showLuckyOverlay(){
  luckyTitle.textContent = `âœ¨ ãƒ©ãƒƒã‚­ãƒ¼ï¼ ${currentPlayer} ã•ã‚“ã¯å¥½ããªå¸­ã‚’é¸ã¶ã“ã¨ãŒã§ãã¾ã™ï¼ âœ¨`;
  seatGridOverlay.innerHTML='';
  [...seats].sort((a,b)=>a-b).forEach(n=>{
    const btn=document.createElement('button'); btn.className='seat-btn'; btn.textContent=n;
    btn.addEventListener('click', ()=> chooseLuckySeat(n), { once:true });
    seatGridOverlay.appendChild(btn);
  });
  luckyOverlay.style.display='grid';
  if (!muted) { try { fanfare.currentTime=0; fanfare.play(); } catch(e){} }
  if (!confettiRunning) launchConfetti(1800, 280, true);
}
function chooseLuckySeat(n){
  currentNumber = n;
  seats = seats.filter(x=> x!==n);
  luckyOverlay.style.display='none';
  resultsDiv.innerHTML += `<div class="result-item">ğŸ‰ <strong>ãƒ©ãƒƒã‚­ãƒ¼ï¼</strong> <strong>${currentPlayer}</strong> ã•ã‚“ã¯ å¥½ããªå¸­ <strong>${currentNumber}</strong> ã‚’é¸ã³ã¾ã—ãŸï¼</div>`;
  numberDisplay.textContent='---';
  commitSeat(currentNumber, currentPlayer);
  finishOne();
}

/* ===== é€šå¸¸å½“é¸ã‚ªãƒ¼ãƒãƒ¼ãƒ¬ã‚¤ï¼ˆã‚¿ãƒƒãƒ—ã§é–‰ã˜ã‚‹ï¼‰ ===== */
revealOverlay.addEventListener('click', ()=>{
  revealOverlay.style.display='none';
  resultsDiv.innerHTML += `<div class="result-item">â†’ <strong>${currentPlayer}</strong> ã•ã‚“ã¯ <strong>å¸­ç•ªå· ${currentNumber}</strong> ã«æ±ºå®šã—ã¾ã—ãŸã€‚</div>`;
  numberDisplay.textContent='---';
  commitSeat(currentNumber, currentPlayer);
  finishOne();
});

/* ===== åº§å¸­ç¢ºå®šã®æç”»æ›´æ–° ===== */
function commitSeat(seatNo, name){
  seatNameByNo.set(seatNo, name);
  const el = seatCellByNo.get(seatNo);
  if (el){
    el.classList.add('is-taken');
    const nameEl = el.querySelector('.name');
    if (nameEl) nameEl.textContent = name;
  }
}

/* ===== çµæœå¾Œã®å…±é€šå‡¦ç† ===== */
function finishOne(){
  stopBtn.style.display='none'; startBtn.disabled=false; startBtn.style.opacity=1; resetBtn.disabled=false;

  assigned.add(currentPlayer); currentPlayer=null; populateNameSelect();
  currentNameSel.disabled=false;

  if (seats.length===0){ finished=true; startBtn.disabled=true; stopBtn.disabled=true; }
  updateStatus();
}

/* ===== ãã®ä»– ===== */
function resetAll(){
  if (intervalId){ clearInterval(intervalId); intervalId=null; }
  drum.pause(); fanfare.pause();
  seats=[]; currentNumber=null; finished=false; resultsDiv.innerHTML=''; numberDisplay.textContent='---';
  startBtn.disabled=false; startBtn.style.opacity=1; stopBtn.disabled=false; stopBtn.style.display='none';
  assigned.clear(); populateNameSelect();
  initFromLayout();  // ãƒãƒƒãƒ—ã‚’ã‚¯ãƒªã‚¢ã—ã¦å†æç”»
  revealOverlay.style.display='none'; luckyOverlay.style.display='none';
  confettiCanvas.style.display='none'; confettiRunning=false;
  updateStatus();
}
function toggleMute(){ muted=!muted; muteBtn.textContent = muted ? 'ğŸ”‡ ãƒŸãƒ¥ãƒ¼ãƒˆè§£é™¤' : 'ğŸ”Š ã‚µã‚¦ãƒ³ãƒ‰'; muteBtn.setAttribute('aria-pressed', String(muted)); if (muted){ drum.pause(); fanfare.pause(); } }
async function checkUpdate(){
  if (!('serviceWorker' in navigator)) return;
  const reg = await navigator.serviceWorker.getRegistration(); if (!reg) return;
  await reg.update();
  if (reg.waiting) reg.waiting.postMessage({type:'SKIP_WAITING'});
  else if (reg.installing) reg.installing.addEventListener('statechange', ()=>{ if (reg.waiting) reg.waiting.postMessage({type:'SKIP_WAITING'}); });
}
navigator.serviceWorker.addEventListener('controllerchange', ()=> location.reload());

/* ===== ã‚¤ãƒ™ãƒ³ãƒˆ ===== */
startBtn.addEventListener('click', startDraw);
stopBtn.addEventListener('click', stopDraw);
resetBtn.addEventListener('click', resetAll);
muteBtn.addEventListener('click', toggleMute);
updateBtn.addEventListener('click', checkUpdate);

/* ===== èµ·å‹•æ™‚ ===== */
renderSeatMap();
initFromLayout();
populateNameSelect();

/* ===== SWç™»éŒ² ===== */
if ('serviceWorker' in navigator) {
  navigator.serviceWorker.register('./service-worker.js', { scope: './' }).then(()=> console.log('SW registered'));
}
</script>
</body>
</html>
