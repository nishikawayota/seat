<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>å¸­æ±ºã‚ãã˜å¼•ã</title>

<!-- PWA -->
<link rel="manifest" href="manifest.json?v=11">
<meta name="theme-color" content="#3498db">
<link rel="icon" href="icons/icon-192.png">

<style>
  :root { --primary:#3498db; --accent:#e74c3c; --bg:#f0f0f0; --gold:#f59e0b; }
  body { font-family: system-ui, -apple-system, "Segoe UI", Roboto, sans-serif;
         text-align: center; padding: 20px; background: var(--bg); }
  h1 { color: #333; margin-bottom: 10px; }
  input, button { padding: 10px; font-size: 18px; margin: 10px; }
  .btn { background: var(--primary); color: #fff; border: none; border-radius: 8px; cursor: pointer; }
  .btn:disabled { opacity: .5; cursor: not-allowed; }
  .row { display:flex; gap:8px; justify-content:center; flex-wrap:wrap; }

  #numberDisplay { font-size: 56px; font-weight: 800; margin: 24px 0 8px; color: var(--accent); min-height: 1.2em; }
  #status { margin-top: 6px; font-size: 16px; color: #2c3e50; min-height: 1.2em; }
  #results { margin-top: 18px; font-size: 18px; }

  /* === å½“é¸è¡¨ç¤ºã‚ªãƒ¼ãƒãƒ¼ãƒ¬ã‚¤ï¼ˆé€šå¸¸ï¼‰ === */
  #revealOverlay {
    position: fixed; inset: 0; display: none; place-items: center;
    background: rgba(0,0,0,.35); backdrop-filter: blur(2px);
    z-index: 9999; pointer-events: auto;
  }
  .reveal-card {
    background: #fff; padding: 24px 28px; border-radius: 16px;
    box-shadow: 0 10px 40px rgba(0,0,0,.25);
    display:flex; flex-direction:column; align-items:center; gap:8px;
    animation: popIn .45s ease-out, glowPulse 1.2s ease-in-out 0s 2;
    border: 4px solid var(--primary);
    touch-action: manipulation;
  }
  .reveal-number {
    font-size: clamp(64px, 16vw, 140px);
    line-height: 1; font-weight: 900; color: var(--accent);
    text-shadow: 0 6px 18px rgba(231,76,60,.35);
    animation: bounce .9s ease-out;
  }
  .reveal-label { font-size: 18px; color:#34495e; }
  .reveal-sub { font-size: 14px; color:#6b7280; }

  /* === ãƒ©ãƒƒã‚­ãƒ¼ï¼ˆå¥½ããªå¸­ï¼‰ã‚ªãƒ¼ãƒãƒ¼ãƒ¬ã‚¤ === */
  #luckyOverlay {
    position: fixed; inset: 0; display: none; place-items: center;
    background: rgba(0,0,0,.45); backdrop-filter: blur(2px);
    z-index: 10000; pointer-events: auto;
  }
  .lucky-card {
    background: #fff; padding: 20px; border-radius: 16px;
    box-shadow: 0 10px 50px rgba(0,0,0,.3);
    border: 4px solid var(--gold);
    width: min(720px, 92vw);
    animation: popIn .45s ease-out, goldPulse 1.4s ease-in-out 0s 2;
  }
  .lucky-title {
    font-size: clamp(22px, 5vw, 28px); font-weight: 900; color: #92400e;
    margin-bottom: 10px; display:flex; align-items:center; justify-content:center; gap:8px;
  }
  .lucky-title .sparkle { font-size: 1.2em; }
  .seat-grid {
    display: grid; gap: 8px; grid-template-columns: repeat(auto-fill, minmax(64px, 1fr));
    margin-top: 12px;
  }
  .seat-btn {
    padding: 10px 0; border-radius: 10px; border: 2px solid #e5e7eb; background: #fff; cursor: pointer;
    font-weight: 700;
  }
  .seat-btn:hover { border-color: var(--gold); box-shadow: 0 0 0 3px rgba(245,158,11,.15) inset; }
  .seat-btn:disabled { opacity: .5; cursor: not-allowed; }

  @keyframes popIn { from { transform: scale(.7); opacity: 0; } to { transform: scale(1); opacity: 1; } }
  @keyframes bounce { 0%{ transform: scale(.6); } 60%{ transform: scale(1.15);} 100%{ transform: scale(1);} }
  @keyframes glowPulse { 0%{ box-shadow: 0 0 0 rgba(52,152,219,0);} 50%{ box-shadow: 0 0 40px rgba(52,152,219,.4);} 100%{ box-shadow:0 0 0 rgba(52,152,219,0);} }
  @keyframes goldPulse { 0%{ box-shadow: 0 0 0 rgba(245,158,11,0);} 50%{ box-shadow: 0 0 50px rgba(245,158,11,.45);} 100%{ box-shadow:0 0 0 rgba(245,158,11,0);} }

  /* ç´™å¹é›ªã‚­ãƒ£ãƒ³ãƒã‚¹ */
  #confettiCanvas {
    position: fixed; inset:0; z-index: 9998; pointer-events:none; display:none;
  }

  /* ã‚ªãƒ—ã‚·ãƒ§ãƒ³è¡Œï¼ˆç¢ºç‡è¨­å®šï¼‰ */
  #options { margin-top: 6px; font-size: 14px; color:#374151; }
  #options input { width: 6em; text-align: right; }
</style>
</head>
<body>

<h1>å¸­æ±ºã‚ãã˜å¼•ã</h1>

<div class="row">
  <input type="number" id="count" placeholder="äººæ•°ã‚’å…¥åŠ›" min="1" inputmode="numeric">
  <button class="btn" id="startBtn">ã‚¹ã‚¿ãƒ¼ãƒˆ</button>
  <button class="btn" id="stopBtn" style="display:none;">ã‚¹ãƒˆãƒƒãƒ—ï¼</button>
  <button class="btn" id="resetBtn">ãƒªã‚»ãƒƒãƒˆ</button>
  <button class="btn" id="muteBtn" aria-pressed="false">ğŸ”Š ãƒŸãƒ¥ãƒ¼ãƒˆ</button>
  <button class="btn" id="updateBtn">ğŸ”„ æ›´æ–°</button>
</div>

<div id="options">
  ãƒ©ãƒƒã‚­ãƒ¼æŠ½é¸ã®ç¢ºç‡ï¼š
  <input type="number" id="luckyProb" step="0.001" min="0" max="1" placeholder="æœªè¨­å®šãªã‚‰ 1/åˆæœŸäººæ•°" />
  ï¼ˆ0ã€œ1ã€ä¾‹ï¼š0.1ã§10%ï¼‰
</div>

<div id="numberDisplay">---</div>
<div id="status"></div>
<div id="results"></div>

<!-- éŸ³ï¼ˆå¿…è¦ã«å¿œã˜ã¦ .wav â†’ .mp3 ã«å·®ã—æ›¿ãˆå¯ï¼‰ -->
<audio id="drum" src="sounds/drumroll.mp3?v=11" preload="auto" loop></audio>
<audio id="fanfare" src="sounds/fanfare.mp3?v=11" preload="auto"></audio>

<!-- ç´™å¹é›ªï¼†å½“é¸ãƒªãƒ“ãƒ¼ãƒ«ï¼ˆé€šå¸¸ï¼‰ -->
<canvas id="confettiCanvas"></canvas>
<div id="revealOverlay" aria-hidden="true">
  <div class="reveal-card" role="dialog" aria-modal="true" aria-live="assertive">
    <div class="reveal-label">å½“é¸å¸­ç•ªå·</div>
    <div id="revealNumber" class="reveal-number">--</div>
    <div class="reveal-sub">ã‚¿ãƒƒãƒ—ã§é–‰ã˜ã‚‹</div>
  </div>
</div>

<!-- ãƒ©ãƒƒã‚­ãƒ¼ï¼ˆå¥½ããªå¸­ã‚’é¸ã¹ã‚‹ï¼‰ -->
<div id="luckyOverlay" aria-hidden="true">
  <div class="lucky-card" role="dialog" aria-modal="true" aria-live="assertive">
    <div class="lucky-title"><span class="sparkle">âœ¨</span>ãƒ©ãƒƒã‚­ãƒ¼ï¼å¥½ããªå¸­ã‚’é¸ã¶ã“ã¨ãŒã§ãã¾ã™ï¼<span class="sparkle">âœ¨</span></div>
    <div>æ®‹ã£ã¦ã„ã‚‹å¸­ã‹ã‚‰1ã¤é¸ã‚“ã§ãã ã•ã„ã€‚</div>
    <div id="seatGrid" class="seat-grid" style="margin-top:10px"></div>
    <div style="margin-top:10px; font-size:12px; color:#6b7280;">â€»ã‚¿ãƒƒãƒ—ã™ã‚‹ã¨ç¢ºå®šã—ã¾ã™</div>
  </div>
</div>

<script>
let seats = [];
let intervalId = null;
let currentNumber = null;
let finished = false;
let muted = false;
let totalCount = 0;
let initialCount = 0;

const startBtn = document.getElementById('startBtn');
const stopBtn  = document.getElementById('stopBtn');
const resetBtn = document.getElementById('resetBtn');
const muteBtn  = document.getElementById('muteBtn');
const updateBtn= document.getElementById('updateBtn');
const numberDisplay = document.getElementById('numberDisplay');
const resultsDiv = document.getElementById('results');
const statusDiv = document.getElementById('status');
const drum = document.getElementById('drum');
const fanfare = document.getElementById('fanfare');
const luckyProbInput = document.getElementById('luckyProb');

const confettiCanvas = document.getElementById('confettiCanvas');
const ctx = confettiCanvas.getContext('2d');
const revealOverlay = document.getElementById('revealOverlay');
const revealNumberEl = document.getElementById('revealNumber');

const luckyOverlay = document.getElementById('luckyOverlay');
const seatGrid = document.getElementById('seatGrid');

function resizeCanvas(){
  confettiCanvas.width = window.innerWidth;
  confettiCanvas.height = window.innerHeight;
}
window.addEventListener('resize', resizeCanvas); resizeCanvas();

/* ====== ç´™å¹é›ª ====== */
let confetti = [];
let confettiRunning = false;
function launchConfetti(duration=1600, count=220, gold=false){
  confetti = [];
  const w = confettiCanvas.width, h = confettiCanvas.height;
  for(let i=0; i<count; i++){
    const hue = gold ? (45 + Math.random()*30) : Math.floor(Math.random()*360);
    confetti.push({
      x: Math.random()*w,
      y: -20 - Math.random()*h*0.4,
      r: 4 + Math.random()*6,
      vx: -1 + Math.random()*2,
      vy: 2 + Math.random()*3,
      rot: Math.random()*Math.PI*2,
      vr: -0.3 + Math.random()*0.6,
      color: gold ? `hsl(${hue},90%,55%)` : `hsl(${hue},85%,55%)`
    });
  }
  const start = performance.now();
  confettiCanvas.style.display = 'block';
  confettiRunning = true;

  function tick(now){
    const t = now - start;
    ctx.clearRect(0,0,w,h);
    confetti.forEach(p=>{
      p.x += p.vx; p.y += p.vy;
      p.rot += p.vr; p.vy += 0.02;
      drawConfetti(p);
    });
    if (t < duration){ requestAnimationFrame(tick); }
    else { confettiRunning = false; confettiCanvas.style.display = 'none'; }
  }
  requestAnimationFrame(tick);
}
function drawConfetti(p){
  ctx.save(); ctx.translate(p.x, p.y); ctx.rotate(p.rot);
  ctx.fillStyle = p.color; ctx.fillRect(-p.r, -p.r*0.6, p.r*2, p.r*1.2);
  ctx.restore();
}

/* ====== çŠ¶æ…‹è¡¨ç¤º ====== */
function updateStatus() {
  if (finished) statusDiv.textContent = 'ãƒ«ãƒ¼ãƒ¬ãƒƒãƒˆãŒçµ‚äº†ã—ã¾ã—ãŸ';
  else if (seats.length > 0) statusDiv.textContent = `æ®‹ã‚Š ${seats.length} / åˆè¨ˆ ${totalCount}`;
  else statusDiv.textContent = '';
}

function initSeats(count) {
  totalCount = count;
  initialCount = count;
  seats = Array.from({length: count}, (_, i) => i + 1);
  finished = false;
  resultsDiv.innerHTML = '';
  numberDisplay.textContent = '---';
  updateStatus();
}

/* ====== ãƒ©ãƒƒã‚­ãƒ¼åˆ¤å®š ======
   å…¥åŠ›ãŒã‚ã‚Œã° luckyProbInputï¼ˆ0ã€œ1ï¼‰ã‚’ä½¿ã„ã€
   æœªè¨­å®šãªã‚‰ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã§ 1 / initialCount ã‚’ä½¿ç”¨ */
function isLuckyHit() {
  const input = parseFloat(luckyProbInput.value);
  const p = (!isNaN(input) && input >= 0 && input <= 1) ? input : (initialCount > 0 ? (1 / initialCount) : 0.1);
  return Math.random() < p;
}

function startDraw() {
  const countInput = parseInt(document.getElementById('count').value);
  if (!seats.length && !finished) {
    if (!countInput || countInput <= 0) { alert('äººæ•°ã‚’æ­£ã—ãå…¥åŠ›ã—ã¦ãã ã•ã„'); return; }
    initSeats(countInput);
  }
  if (finished) return;

  stopBtn.style.display = 'inline-block';
  startBtn.disabled = true;
  resetBtn.disabled = true;

  if (!muted) { try { drum.currentTime = 0; drum.play(); } catch(e) {} }

  intervalId = setInterval(() => {
    currentNumber = seats[Math.floor(Math.random() * seats.length)];
    numberDisplay.textContent = currentNumber;
  }, 50);
}

function stopDraw() {
  if (!intervalId) return;
  clearInterval(intervalId);
  intervalId = null;
  drum.pause();

  // â”€â”€ ãƒ©ãƒƒã‚­ãƒ¼æŠ½é¸ï¼ˆå¥½ããªå¸­ã‚’é¸ã¹ã‚‹ï¼‰ â”€â”€
  if (seats.length > 1 && isLuckyHit()) {
    showLuckyOverlay(); // â† ã“ã“ã§ç‰¹åˆ¥æ¼”å‡ºï¼†é¸æŠã¸
    return;
  }

  // â”€â”€ é€šå¸¸ã®ç¢ºå®šè¡¨ç¤º â”€â”€
  seats = seats.filter(num => num !== currentNumber);
  revealNumberEl.textContent = currentNumber;
  revealOverlay.style.display = 'grid';
  if (!muted) { try { fanfare.currentTime = 0; fanfare.play(); } catch(e) {} }
  if (!confettiRunning) launchConfetti(1600, 220, false);
}

/* ====== ãƒ©ãƒƒã‚­ãƒ¼å‡¦ç† ====== */
function showLuckyOverlay(){
  // åº§å¸­ã‚°ãƒªãƒƒãƒ‰ã‚’æ§‹ç¯‰
  seatGrid.innerHTML = '';
  const sorted = [...seats].sort((a,b)=>a-b);
  sorted.forEach(n => {
    const btn = document.createElement('button');
    btn.className = 'seat-btn';
    btn.textContent = n;
    btn.addEventListener('click', () => chooseLuckySeat(n), { once:true });
    seatGrid.appendChild(btn);
  });

  // é‡‘ç´™å¹é›ªï¼†ï¼ˆåŒã˜ãƒ•ã‚¡ãƒ³ãƒ•ã‚¡ãƒ¼ãƒ¬ã§OKï¼‰
  luckyOverlay.style.display = 'grid';
  if (!muted) { try { fanfare.currentTime = 0; fanfare.play(); } catch(e) {} }
  if (!confettiRunning) launchConfetti(1800, 260, true);
}

function chooseLuckySeat(n){
  // é¸ã‚“ã ç•ªå·ã‚’ç¢ºå®š
  currentNumber = n;
  seats = seats.filter(x => x !== n);

  // ã‚ªãƒ¼ãƒãƒ¼ãƒ¬ã‚¤ã‚’é–‰ã˜ã¦çµæœã¸
  luckyOverlay.style.display = 'none';
  resultsDiv.innerHTML += `<div>ğŸ‰ <strong>ãƒ©ãƒƒã‚­ãƒ¼ï¼</strong> å¥½ããªå¸­ <strong>${currentNumber}</strong> ã‚’é¸ã³ã¾ã—ãŸï¼</div>`;
  numberDisplay.textContent = '---';

  stopBtn.style.display = 'none';
  startBtn.disabled = false;
  resetBtn.disabled = false;

  if (seats.length === 0) {
    finished = true;
    startBtn.disabled = true;
    stopBtn.disabled = true;
    updateStatus();
    return;
  }
  updateStatus();
}

/* ====== é€šå¸¸ã®å½“é¸ã‚ªãƒ¼ãƒãƒ¼ãƒ¬ã‚¤ã‚’ã‚¿ãƒƒãƒ—ã§é–‰ã˜ã‚‹ ====== */
revealOverlay.addEventListener('click', () => {
  revealOverlay.style.display = 'none';
  resultsDiv.innerHTML += `<div>â†’ å¸­ç•ªå· <strong>${currentNumber}</strong> æ±ºå®šï¼</div>`;
  numberDisplay.textContent = '---';

  stopBtn.style.display = 'none';
  startBtn.disabled = false;
  resetBtn.disabled = false;

  if (seats.length === 0) {
    finished = true;
    startBtn.disabled = true;
    stopBtn.disabled = true;
    updateStatus();
    return;
  }
  updateStatus();
});

function resetAll() {
  if (intervalId) { clearInterval(intervalId); intervalId = null; }
  drum.pause(); fanfare.pause();
  seats = []; currentNumber = null; finished = false;
  numberDisplay.textContent = '---'; resultsDiv.innerHTML = '';
  startBtn.disabled = false; stopBtn.disabled = false; stopBtn.style.display = 'none';
  revealOverlay.style.display = 'none'; luckyOverlay.style.display = 'none';
  confettiCanvas.style.display = 'none'; confettiRunning = false;
  updateStatus();
}

function toggleMute() {
  muted = !muted;
  muteBtn.textContent = muted ? 'ğŸ”‡ ãƒŸãƒ¥ãƒ¼ãƒˆè§£é™¤' : 'ğŸ”Š ãƒŸãƒ¥ãƒ¼ãƒˆ';
  muteBtn.setAttribute('aria-pressed', String(muted));
  if (muted) { drum.pause(); fanfare.pause(); }
}

/* ==== æ›´æ–°ãƒœã‚¿ãƒ³ï¼ˆSWå¼·åˆ¶æ›´æ–°ï¼‰ ==== */
async function checkUpdate() {
  if (!('serviceWorker' in navigator)) return;
  const reg = await navigator.serviceWorker.getRegistration();
  if (!reg) return;
  await reg.update();
  if (reg.waiting)      reg.waiting.postMessage({type:'SKIP_WAITING'});
  else if (reg.installing)
    reg.installing.addEventListener('statechange', () => {
      if (reg.waiting) reg.waiting.postMessage({type:'SKIP_WAITING'});
    });
}
navigator.serviceWorker.addEventListener('controllerchange', () => window.location.reload());

startBtn.addEventListener('click', startDraw);
stopBtn.addEventListener('click', stopDraw);
resetBtn.addEventListener('click', resetAll);
muteBtn.addEventListener('click', toggleMute);
updateBtn.addEventListener('click', checkUpdate);

// SWç™»éŒ²
if ('serviceWorker' in navigator) {
  navigator.serviceWorker.register('./service-worker.js', { scope: './' })
    .then(() => console.log('SW registered'));
}
</script>
</body>
</html>
