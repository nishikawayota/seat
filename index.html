<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>å¸­æ±ºã‚ãã˜å¼•ã</title>

<!-- PWA -->
<link rel="manifest" href="manifest.json?v=14" />
<meta name="theme-color" content="#3498db" />
<link rel="icon" href="icons/icon-192.png" />

<style>
  :root { --primary:#3498db; --accent:#e74c3c; --bg:#f0f0f0; --gold:#f59e0b; }
  body { font-family: system-ui, -apple-system, "Segoe UI", Roboto, sans-serif; text-align: center; padding: 20px; background: var(--bg); }
  h1 { color: #333; margin-bottom: 10px; }
  input, button, select, textarea { padding: 10px; font-size: 16px; margin: 6px; }
  .btn { background: var(--primary); color: #fff; border: none; border-radius: 8px; cursor: pointer; }
  .btn:disabled { opacity: .5; cursor: not-allowed; }
  .row { display:flex; gap:8px; justify-content:center; flex-wrap:wrap; }

  #numberDisplay { font-size: 56px; font-weight: 800; margin: 16px 0 6px; color: var(--accent); min-height: 1.2em; }
  #status { margin-top: 6px; font-size: 16px; color: #2c3e50; min-height: 1.2em; }
  #results { margin-top: 18px; font-size: 18px; text-align:left; max-width: 720px; margin-inline:auto; }

  /* åç°¿ã‚¨ãƒªã‚¢ */
  #namesWrap { display:grid; grid-template-columns: 1fr; gap:8px; max-width: 720px; margin: 8px auto 0; }
  #namesInput { width: 100%; height: 120px; resize: vertical; }
  #currentWrap { display:flex; gap:8px; justify-content:center; align-items:center; flex-wrap:wrap; }
  #currentName { min-width: 200px; }

  /* === å½“é¸è¡¨ç¤ºã‚ªãƒ¼ãƒãƒ¼ãƒ¬ã‚¤ï¼ˆé€šå¸¸ï¼‰ === */
  #revealOverlay { position: fixed; inset: 0; display: none; place-items: center; background: rgba(0,0,0,.35); backdrop-filter: blur(2px); z-index: 9999; }
  .reveal-card { background: #fff; padding: 24px 28px; border-radius: 16px; box-shadow: 0 10px 40px rgba(0,0,0,.25);
    display:flex; flex-direction:column; align-items:center; gap:8px; animation: popIn .45s ease-out, glowPulse 1.2s ease-in-out 0s 2; border: 4px solid var(--primary); max-width: 92vw; }
  .reveal-title { font-size: clamp(18px, 4.8vw, 22px); color:#34495e; font-weight: 700; }
  .reveal-number { font-size: clamp(64px, 16vw, 140px); line-height: 1; font-weight: 900; color: var(--accent);
    text-shadow: 0 6px 18px rgba(231,76,60,.35); animation: bounce .9s ease-out; }
  .reveal-sub { font-size: 14px; color:#6b7280; }

  /* === ãƒ©ãƒƒã‚­ãƒ¼ï¼ˆå¥½ããªå¸­ï¼‰ã‚ªãƒ¼ãƒãƒ¼ãƒ¬ã‚¤ === */
  #luckyOverlay { position: fixed; inset: 0; display: none; place-items: center; background: rgba(0,0,0,.45); backdrop-filter: blur(2px); z-index: 10000; }
  .lucky-card { background: #fff; padding: 20px; border-radius: 16px; box-shadow: 0 10px 50px rgba(0,0,0,.3); border: 4px solid var(--gold);
    width: min(720px, 92vw); animation: popIn .45s ease-out, goldPulse 1.4s ease-in-out 0s 2; }
  .lucky-title { font-size: clamp(20px, 5vw, 26px); font-weight: 900; color: #92400e; margin-bottom: 10px; display:flex; align-items:center; justify-content:center; gap:8px; }
  .lucky-title .sparkle { font-size: 1.2em; }
  .seat-grid { display: grid; gap: 8px; grid-template-columns: repeat(auto-fill, minmax(64px, 1fr)); margin-top: 12px; }
  .seat-btn { padding: 10px 0; border-radius: 10px; border: 2px solid #e5e7eb; background: #fff; cursor: pointer; font-weight: 700; }
  .seat-btn:hover { border-color: var(--gold); box-shadow: 0 0 0 3px rgba(245,158,11,.15) inset; }
  .seat-btn:disabled { opacity: .5; cursor: not-allowed; }

  @keyframes popIn { from { transform: scale(.7); opacity: 0; } to { transform: scale(1); opacity: 1; } }
  @keyframes bounce { 0%{ transform: scale(.6); } 60%{ transform: scale(1.15);} 100%{ transform: scale(1);} }
  @keyframes glowPulse { 0%{ box-shadow: 0 0 0 rgba(52,152,219,0);} 50%{ box-shadow: 0 0 40px rgba(52,152,219,.4);} 100%{ box-shadow:0 0 0 rgba(52,152,219,0);} }
  @keyframes goldPulse { 0%{ box-shadow: 0 0 0 rgba(245,158,11,0);} 50%{ box-shadow: 0 0 50px rgba(245,158,11,.45);} 100%{ box-shadow:0 0 0 rgba(245,158,11,0);} }

  /* ç´™å¹é›ªã‚­ãƒ£ãƒ³ãƒã‚¹ */
  #confettiCanvas { position: fixed; inset:0; z-index: 9998; pointer-events:none; display:none; }

  /* ã‚ªãƒ—ã‚·ãƒ§ãƒ³ï¼ˆç¢ºç‡ & TTSï¼‰ */
  #options { margin-top: 6px; font-size: 14px; color:#374151; display:flex; gap:10px; justify-content:center; flex-wrap:wrap; }
  #options input[type="number"] { width: 6em; text-align: right; }
  #ttsWrap { display:flex; gap:6px; align-items:center; flex-wrap:wrap; }
  #voiceSelect { min-width: 220px; }
  .range { width: 160px; }
</style>
</head>
<body>

<h1>å¸­æ±ºã‚ãã˜å¼•ã</h1>

<!-- åç°¿è¨­å®š -->
<div id="namesWrap">
  <div style="text-align:left;"><strong>å‚åŠ è€…ãƒªã‚¹ãƒˆï¼ˆ1è¡Œã«1åï¼‰</strong></div>
  <textarea id="namesInput" placeholder="ä¾‹ï¼š&#10;ç”°ä¸­&#10;ä½è—¤&#10;éˆ´æœ¨"></textarea>
  <div class="row">
    <button class="btn" id="setNamesBtn">åç°¿ã‚’ã‚»ãƒƒãƒˆ</button>
    <span id="namesInfo" style="align-self:center; color:#374151;">æœªè¨­å®š</span>
  </div>
</div>

<!-- æ“ä½œè¡Œ -->
<div class="row" id="currentWrap">
  <label for="currentName">ä»Šå›å›ã™äººï¼š</label>
  <select id="currentName"><option value="">ï¼ˆåç°¿ã‚’ã‚»ãƒƒãƒˆã—ã¦ãã ã•ã„ï¼‰</option></select>
  <input type="number" id="count" placeholder="äººæ•°ã‚’å…¥åŠ›ï¼ˆæœªå…¥åŠ›ãªã‚‰åç°¿äººæ•°ï¼‰" min="1" inputmode="numeric" />
  <button class="btn" id="startBtn">ã‚¹ã‚¿ãƒ¼ãƒˆ</button>
  <button class="btn" id="stopBtn" style="display:none;">ã‚¹ãƒˆãƒƒãƒ—ï¼</button>
  <button class="btn" id="resetBtn">ãƒªã‚»ãƒƒãƒˆ</button>
  <button class="btn" id="muteBtn" aria-pressed="false">ğŸ”Š ãƒŸãƒ¥ãƒ¼ãƒˆ</button>
  <button class="btn" id="updateBtn">ğŸ”„ æ›´æ–°</button>
</div>

<div id="options">
  <div>
    ãƒ©ãƒƒã‚­ãƒ¼æŠ½é¸ã®ç¢ºç‡ï¼š
    <input type="number" id="luckyProb" step="0.001" min="0" max="1" placeholder="æœªè¨­å®šãªã‚‰ 1/åˆæœŸäººæ•°" />
    ï¼ˆ0ã€œ1ã€ä¾‹ï¼š0.1ã§10%ï¼‰
  </div>
  <div id="ttsWrap">
    <label><input type="checkbox" id="ttsEnabled" /> èª­ã¿ä¸Šã’ON</label>
    <select id="voiceSelect" title="éŸ³å£°ï¼ˆæ—¥æœ¬èªæ¨å¥¨ï¼‰"></select>
    <label>é€Ÿã• <input type="range" id="rate" class="range" min="0.5" max="1.5" step="0.05" value="1" /></label>
    <label>é«˜ã• <input type="range" id="pitch" class="range" min="0" max="2" step="0.1" value="1" /></label>
    <label>éŸ³é‡ <input type="range" id="volume" class="range" min="0" max="1" step="0.05" value="1" /></label>
  </div>
</div>

<div id="numberDisplay">---</div>
<div id="status"></div>
<div id="results"></div>

<!-- åŠ¹æœéŸ³ -->
<audio id="drum" src="sounds/drumroll.mp3?v=14" preload="auto" loop></audio>
<audio id="fanfare" src="sounds/fanfare.mp3?v=14" preload="auto"></audio>

<!-- ç´™å¹é›ªï¼†å½“é¸ãƒªãƒ“ãƒ¼ãƒ«ï¼ˆé€šå¸¸ï¼‰ -->
<canvas id="confettiCanvas"></canvas>
<div id="revealOverlay" aria-hidden="true">
  <div class="reveal-card" role="dialog" aria-modal="true" aria-live="assertive">
    <div id="revealTitle" class="reveal-title">å½“é¸å¸­ç•ªå·</div>
    <div id="revealNumber" class="reveal-number">--</div>
    <div class="reveal-sub">ã‚¿ãƒƒãƒ—ã§é–‰ã˜ã‚‹</div>
  </div>
</div>

<!-- ãƒ©ãƒƒã‚­ãƒ¼ï¼ˆå¥½ããªå¸­ã‚’é¸ã¹ã‚‹ï¼‰ -->
<div id="luckyOverlay" aria-hidden="true">
  <div class="lucky-card" role="dialog" aria-modal="true" aria-live="assertive">
    <div id="luckyTitle" class="lucky-title"><span class="sparkle">âœ¨</span>ãƒ©ãƒƒã‚­ãƒ¼ï¼å¥½ããªå¸­ã‚’é¸ã¶ã“ã¨ãŒã§ãã¾ã™ï¼<span class="sparkle">âœ¨</span></div>
    <div id="luckySub">æ®‹ã£ã¦ã„ã‚‹å¸­ã‹ã‚‰1ã¤é¸ã‚“ã§ãã ã•ã„ã€‚</div>
    <div id="seatGrid" class="seat-grid" style="margin-top:10px"></div>
    <div style="margin-top:10px; font-size:12px; color:#6b7280;">â€»ã‚¿ãƒƒãƒ—ã™ã‚‹ã¨ç¢ºå®šã—ã¾ã™</div>
  </div>
</div>

<script>
/* ================== çŠ¶æ…‹ ================== */
let seats = [];
let intervalId = null;
let currentNumber = null;
let finished = false;
let muted = false;
let totalCount = 0;
let initialCount = 0;

let names = [];
let assigned = new Set();
let currentPlayer = null;

/* ================== è¦ç´ å‚ç…§ ================== */
const startBtn = document.getElementById('startBtn');
const stopBtn  = document.getElementById('stopBtn');
const resetBtn = document.getElementById('resetBtn');
const muteBtn  = document.getElementById('muteBtn');
const updateBtn= document.getElementById('updateBtn');
const numberDisplay = document.getElementById('numberDisplay');
const resultsDiv = document.getElementById('results');
const statusDiv = document.getElementById('status');
const drum = document.getElementById('drum');
const fanfare = document.getElementById('fanfare');
const luckyProbInput = document.getElementById('luckyProb');

const namesInput = document.getElementById('namesInput');
const setNamesBtn = document.getElementById('setNamesBtn');
const namesInfo = document.getElementById('namesInfo');
const currentNameSel = document.getElementById('currentName');

const confettiCanvas = document.getElementById('confettiCanvas');
const ctx = confettiCanvas.getContext('2d');
const revealOverlay = document.getElementById('revealOverlay');
const revealTitleEl = document.getElementById('revealTitle');
const revealNumberEl = document.getElementById('revealNumber');

const luckyOverlay = document.getElementById('luckyOverlay');
const luckyTitle = document.getElementById('luckyTitle');
const seatGrid = document.getElementById('seatGrid');

/* ================== TTSï¼ˆWeb Speech APIï¼‰ ================== */
const ttsEnabled = document.getElementById('ttsEnabled');
const voiceSelect = document.getElementById('voiceSelect');
const rate = document.getElementById('rate');
const pitch = document.getElementById('pitch');
const volume = document.getElementById('volume');

let voices = [];
function loadVoices(){
  voices = window.speechSynthesis ? speechSynthesis.getVoices() : [];
  voiceSelect.innerHTML = '';
  const sorted = voices.slice().sort((a,b)=>{
    const aj = a.lang && a.lang.startsWith('ja') ? -1 : 1;
    const bj = b.lang && b.lang.startsWith('ja') ? -1 : 1;
    if (aj !== bj) return aj - bj;
    return a.name.localeCompare(b.name);
  });
  sorted.forEach(v=>{
    const opt=document.createElement('option');
    opt.value=v.name; opt.textContent=`${v.name} (${v.lang})`;
    voiceSelect.appendChild(opt);
  });
}
if ('speechSynthesis' in window) {
  loadVoices();
  window.speechSynthesis.onvoiceschanged = loadVoices;
}
function speak(text){
  if (!ttsEnabled.checked || !('speechSynthesis' in window)) return;
  const u = new SpeechSynthesisUtterance(text);
  const selectedName = voiceSelect.value;
  const v = voices.find(v => v.name === selectedName) || voices.find(v => v.lang && v.lang.startsWith('ja')) || voices[0];
  if (v) u.voice = v;
  u.rate = parseFloat(rate.value) || 1;
  u.pitch = parseFloat(pitch.value) || 1;
  u.volume = parseFloat(volume.value) || 1;
  window.speechSynthesis.cancel(); // é‡ãªã‚Šã‚’é˜²æ­¢
  window.speechSynthesis.speak(u);
}
function announceNormal(name, seatNo){ speak(`${name} ã•ã‚“ã¯ã€å¸­ç•ªå· ${seatNo} ã«æ±ºå®šã—ã¾ã—ãŸã€‚`); }
function announceLuckyStart(name){ speak(`ãƒ©ãƒƒã‚­ãƒ¼ï¼ ${name} ã•ã‚“ã¯ã€å¥½ããªå¸­ã‚’é¸ã¶ã“ã¨ãŒã§ãã¾ã™ã€‚æ®‹ã£ã¦ã„ã‚‹å¸­ã‹ã‚‰ã€ä¸€ã¤é¸ã‚“ã§ãã ã•ã„ã€‚`); }
function announceLuckyChosen(name, seatNo){ speak(`ãƒ©ãƒƒã‚­ãƒ¼ï¼ ${name} ã•ã‚“ã¯ã€å¸­ç•ªå· ${seatNo} ã‚’é¸ã³ã¾ã—ãŸã€‚`); }

/* ================== åç°¿ ================== */
function setNamesFromText() {
  const lines = namesInput.value.split(/\r?\n/).map(s => s.trim()).filter(Boolean);
  names = Array.from(new Set(lines));
  assigned.clear();
  populateNameSelect();
  namesInfo.textContent = names.length ? `å‚åŠ è€…æ•°ï¼š${names.length}` : 'æœªè¨­å®š';
  const countInputEl = document.getElementById('count');
  if (!countInputEl.value && names.length) countInputEl.value = names.length;
  localStorage.setItem('seatapp:names', names.join('\n'));
}
function populateNameSelect() {
  const remaining = names.filter(n => !assigned.has(n));
  currentNameSel.innerHTML = '';
  if (remaining.length === 0) {
    const opt = document.createElement('option'); opt.value=''; opt.text='ï¼ˆå…¨å“¡æ±ºå®šæ¸ˆã¿ï¼‰';
    currentNameSel.appendChild(opt); return;
  }
  remaining.forEach(n => {
    const opt = document.createElement('option'); opt.value=n; opt.text=n;
    currentNameSel.appendChild(opt);
  });
}
setNamesBtn.addEventListener('click', setNamesFromText);
namesInput.addEventListener('input', ()=> localStorage.setItem('seatapp:names', namesInput.value));

/* ================== ç´™å¹é›ª ================== */
function resizeCanvas(){ confettiCanvas.width = innerWidth; confettiCanvas.height = innerHeight; }
addEventListener('resize', resizeCanvas); resizeCanvas();
let confetti = []; let confettiRunning = false;
function launchConfetti(duration=1600, count=220, gold=false){
  confetti = [];
  const w = confettiCanvas.width, h = confettiCanvas.height;
  for(let i=0;i<count;i++){
    const hue = gold ? (45 + Math.random()*30) : Math.floor(Math.random()*360);
    confetti.push({ x:Math.random()*w, y:-20 - Math.random()*h*0.4, r:4+Math.random()*6, vx:-1+Math.random()*2, vy:2+Math.random()*3,
      rot:Math.random()*Math.PI*2, vr:-0.3+Math.random()*0.6, color: gold ? `hsl(${hue},90%,55%)` : `hsl(${hue},85%,55%)` });
  }
  const start = performance.now(); confettiCanvas.style.display='block'; confettiRunning=true;
  function tick(now){
    const t = now - start;
    ctx.clearRect(0,0,w,h);
    confetti.forEach(p=>{ p.x+=p.vx; p.y+=p.vy; p.rot+=p.vr; p.vy+=0.02;
      ctx.save(); ctx.translate(p.x,p.y); ctx.rotate(p.rot); ctx.fillStyle=p.color; ctx.fillRect(-p.r,-p.r*0.6,p.r*2,p.r*1.2); ctx.restore(); });
    if (t<duration) requestAnimationFrame(tick); else { confettiRunning=false; confettiCanvas.style.display='none'; }
  }
  requestAnimationFrame(tick);
}

/* ================== ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ ================== */
function updateStatus(){
  const remainingSeats = seats.length;
  const remainingPeople = names.filter(n=>!assigned.has(n)).length;
  statusDiv.textContent = finished ? 'ãƒ«ãƒ¼ãƒ¬ãƒƒãƒˆãŒçµ‚äº†ã—ã¾ã—ãŸ' : `æ®‹ã‚Šåº§å¸­ ${remainingSeats} / åˆè¨ˆ ${totalCount}ã€€|ã€€æœªæ±ºå®šã®äºº ${remainingPeople}`;
}

/* ================== åˆæœŸåŒ– ================== */
function initSeats(count){
  totalCount = count; initialCount = count;
  seats = Array.from({length: count}, (_,i)=> i+1);
  finished=false; resultsDiv.innerHTML=''; numberDisplay.textContent='---'; updateStatus();
}

/* ================== ãƒ©ãƒƒã‚­ãƒ¼åˆ¤å®š ================== */
function isLuckyHit(){
  const input = parseFloat(luckyProbInput.value);
  const p = (!isNaN(input) && input>=0 && input<=1) ? input : (initialCount>0 ? (1/initialCount) : 0.1);
  return Math.random() < p;
}

/* ================== ã‚¹ã‚¿ãƒ¼ãƒˆï¼ã‚¹ãƒˆãƒƒãƒ— ================== */
function startDraw(){
  const sel = currentNameSel.value;
  if (!sel) { alert('ä»Šå›å›ã™äººã‚’é¸ã‚“ã§ãã ã•ã„ï¼ˆåç°¿ã‚’ã‚»ãƒƒãƒˆ â†’ é¸æŠï¼‰'); return; }
  if (assigned.has(sel)) { alert('ãã®æ–¹ã¯ã™ã§ã«æ±ºå®šæ¸ˆã¿ã§ã™ã€‚åˆ¥ã®æ–¹ã‚’é¸ã‚“ã§ãã ã•ã„ã€‚'); return; }
  currentPlayer = sel;

  const countInput = parseInt(document.getElementById('count').value);
  if (!seats.length && !finished) {
    const effectiveCount = (!isNaN(countInput) && countInput>0) ? countInput : (names.length || 0);
    if (!effectiveCount) { alert('äººæ•°ã‚’å…¥åŠ›ã™ã‚‹ã‹ã€åç°¿ã‚’ã‚»ãƒƒãƒˆã—ã¦ãã ã•ã„'); return; }
    initSeats(effectiveCount);
  }
  if (finished) return;

  stopBtn.style.display='inline-block'; startBtn.disabled=true; resetBtn.disabled=true;
  currentNameSel.disabled=true; setNamesBtn.disabled=true; namesInput.disabled=true;

  if (!muted) { try { drum.currentTime=0; drum.play(); } catch(e){} }

  intervalId = setInterval(()=>{
    currentNumber = seats[Math.floor(Math.random()*seats.length)];
    numberDisplay.textContent = currentNumber;
  }, 50);
}
function stopDraw(){
  if (!intervalId) return;
  clearInterval(intervalId); intervalId=null; drum.pause();

  if (!currentPlayer) currentPlayer = currentNameSel.value || 'ï¼ˆåç„¡ã—ï¼‰';

  // ãƒ©ãƒƒã‚­ãƒ¼
  if (seats.length>1 && isLuckyHit()) { showLuckyOverlay(); return; }

  // é€šå¸¸
  seats = seats.filter(n=> n!==currentNumber);
  revealTitleEl.textContent = `${currentPlayer} ã•ã‚“ã¯â€¦`;
  revealNumberEl.textContent = currentNumber;
  revealOverlay.style.display='grid';
  if (!muted) { try { fanfare.currentTime=0; fanfare.play(); } catch(e){} }
  if (!confettiRunning) launchConfetti(1600, 220, false);

  // èª­ã¿ä¸Šã’
  announceNormal(currentPlayer, currentNumber);
}

/* ================== ãƒ©ãƒƒã‚­ãƒ¼å‡¦ç† ================== */
function showLuckyOverlay(){
  luckyTitle.innerHTML = `<span class="sparkle">âœ¨</span>${currentPlayer} ã•ã‚“ã¯å¥½ããªå¸­ã‚’é¸ã¶ã“ã¨ãŒã§ãã¾ã™ï¼<span class="sparkle">âœ¨</span>`;
  seatGrid.innerHTML='';
  [...seats].sort((a,b)=>a-b).forEach(n=>{
    const btn=document.createElement('button'); btn.className='seat-btn'; btn.textContent=n;
    btn.addEventListener('click', ()=> chooseLuckySeat(n), { once:true });
    seatGrid.appendChild(btn);
  });
  luckyOverlay.style.display='grid';
  if (!muted) { try { fanfare.currentTime=0; fanfare.play(); } catch(e){} }
  if (!confettiRunning) launchConfetti(1800, 260, true);

  // èª­ã¿ä¸Šã’
  announceLuckyStart(currentPlayer);
}
function chooseLuckySeat(n){
  currentNumber = n;
  seats = seats.filter(x=> x!==n);
  luckyOverlay.style.display='none';
  resultsDiv.innerHTML += `<div>ğŸ‰ <strong>ãƒ©ãƒƒã‚­ãƒ¼ï¼</strong> <strong>${currentPlayer}</strong> ã•ã‚“ã¯ å¥½ããªå¸­ <strong>${currentNumber}</strong> ã‚’é¸ã³ã¾ã—ãŸï¼</div>`;
  numberDisplay.textContent='---';

  // èª­ã¿ä¸Šã’
  announceLuckyChosen(currentPlayer, currentNumber);

  finishOne();
}

/* ================== é€šå¸¸ã‚ªãƒ¼ãƒãƒ¼ãƒ¬ã‚¤ï¼ˆã‚¿ãƒƒãƒ—ã§é–‰ã˜ã‚‹ï¼‰ ================== */
revealOverlay.addEventListener('click', ()=>{
  revealOverlay.style.display='none';
  resultsDiv.innerHTML += `<div>â†’ <strong>${currentPlayer}</strong> ã•ã‚“ã¯ <strong>å¸­ç•ªå· ${currentNumber}</strong> ã«æ±ºå®šã—ã¾ã—ãŸã€‚</div>`;
  numberDisplay.textContent='---';
  finishOne();
});

/* ================== çµæœå¾Œã®å…±é€šå‡¦ç† ================== */
function finishOne(){
  stopBtn.style.display='none'; startBtn.disabled=false; resetBtn.disabled=false;
  assigned.add(currentPlayer); currentPlayer=null; populateNameSelect();
  currentNameSel.disabled=false; setNamesBtn.disabled=false; namesInput.disabled=false;
  if (seats.length===0){ finished=true; startBtn.disabled=true; stopBtn.disabled=true; }
  updateStatus();
}

/* ================== ãƒªã‚»ãƒƒãƒˆãƒ»ãƒŸãƒ¥ãƒ¼ãƒˆãƒ»æ›´æ–° ================== */
function resetAll(){
  if (intervalId){ clearInterval(intervalId); intervalId=null; }
  drum.pause(); fanfare.pause();
  seats=[]; currentNumber=null; finished=false; resultsDiv.innerHTML=''; numberDisplay.textContent='---';
  startBtn.disabled=false; stopBtn.disabled=false; stopBtn.style.display='none';
  revealOverlay.style.display='none'; luckyOverlay.style.display='none';
  confettiCanvas.style.display='none'; confettiRunning=false; assigned.clear(); populateNameSelect();
  currentPlayer=null; currentNameSel.disabled=false; setNamesBtn.disabled=false; namesInput.disabled=false;
  updateStatus();
}
function toggleMute(){ muted=!muted; muteBtn.textContent = muted ? 'ğŸ”‡ ãƒŸãƒ¥ãƒ¼ãƒˆè§£é™¤' : 'ğŸ”Š ãƒŸãƒ¥ãƒ¼ãƒˆ'; muteBtn.setAttribute('aria-pressed', String(muted)); if (muted){ drum.pause(); fanfare.pause(); } }

/* ================== SWæ›´æ–° ================== */
async function checkUpdate(){
  if (!('serviceWorker' in navigator)) return;
  const reg = await navigator.serviceWorker.getRegistration(); if (!reg) return;
  await reg.update();
  if (reg.waiting) reg.waiting.postMessage({type:'SKIP_WAITING'});
  else if (reg.installing) reg.installing.addEventListener('statechange', ()=>{ if (reg.waiting) reg.waiting.postMessage({type:'SKIP_WAITING'}); });
}
navigator.serviceWorker.addEventListener('controllerchange', ()=> location.reload());

/* ================== ã‚¤ãƒ™ãƒ³ãƒˆ ================== */
startBtn.addEventListener('click', startDraw);
stopBtn.addEventListener('click', stopDraw);
resetBtn.addEventListener('click', resetAll);
muteBtn.addEventListener('click', toggleMute);
updateBtn.addEventListener('click', checkUpdate);

/* ================== PWAç™»éŒ² ================== */
if ('serviceWorker' in navigator) {
  navigator.serviceWorker.register('./service-worker.js', { scope: './' }).then(()=> console.log('SW registered'));
}

/* ================== èµ·å‹•æ™‚ï¼šåç°¿å¾©å…ƒ ================== */
window.addEventListener('DOMContentLoaded', ()=>{
  const saved = localStorage.getItem('seatapp:names');
  if (saved && saved.trim()){ namesInput.value = saved; setNamesFromText(); }
});
</script>
</body>
</html>
