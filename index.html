<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>席決めくじ引き</title>

<!-- PWA -->
<link rel="manifest" href="manifest.json?v=8">
<meta name="theme-color" content="#3498db">
<link rel="icon" href="icons/icon-192.png">

<style>
  body { font-family: sans-serif; text-align: center; padding: 20px; background: #f0f0f0; }
  h1 { color: #333; }
  input, button { padding: 10px; font-size: 18px; margin: 10px; }
  #numberDisplay { font-size: 56px; font-weight: bold; margin: 40px 0; color: #e74c3c; min-height: 1.2em; }
  #results { margin-top: 20px; font-size: 18px; }
  .btn { background: #3498db; color: white; border: none; border-radius: 6px; cursor: pointer; }
  .btn:disabled { opacity: 0.5; cursor: not-allowed; }
  #status { margin-top: 16px; font-size: 16px; color: #2c3e50; min-height: 1.2em; }
  .row { display:flex; gap:8px; justify-content:center; flex-wrap:wrap; }
</style>
</head>
<body>

<h1>席決めくじ引き</h1>

<div class="row">
  <input type="number" id="count" placeholder="人数を入力" min="1" inputmode="numeric">
  <button class="btn" id="startBtn">スタート</button>
  <button class="btn" id="stopBtn" style="display:none;">ストップ！</button>
  <button class="btn" id="resetBtn">リセット</button>
  <button class="btn" id="muteBtn" aria-pressed="false">🔊 ミュート</button>
  <button class="btn" id="updateBtn">🔄 更新</button>
</div>

<div id="numberDisplay">---</div>
<div id="status"></div>
<div id="results"></div>

<audio id="drum" src="sounds/drumroll.mp3?v=8" preload="auto" loop></audio>
<audio id="fanfare" src="sounds/fanfare.mp3?v=8" preload="auto"></audio>

<script>
let seats = [];
let intervalId = null;
let currentNumber = null;
let finished = false;
let muted = false;
let totalCount = 0;

const startBtn = document.getElementById('startBtn');
const stopBtn  = document.getElementById('stopBtn');
const resetBtn = document.getElementById('resetBtn');
const muteBtn  = document.getElementById('muteBtn');
const updateBtn= document.getElementById('updateBtn');
const numberDisplay = document.getElementById('numberDisplay');
const resultsDiv = document.getElementById('results');
const statusDiv = document.getElementById('status');
const drum = document.getElementById('drum');
const fanfare = document.getElementById('fanfare');

function updateStatus() {
  if (finished) {
    statusDiv.textContent = 'ルーレットが終了しました';
  } else if (seats.length > 0) {
    statusDiv.textContent = `残り ${seats.length} / 合計 ${totalCount}`;
  } else {
    statusDiv.textContent = '';
  }
}

function initSeats(count) {
  totalCount = count;
  seats = Array.from({length: count}, (_, i) => i + 1);
  finished = false;
  resultsDiv.innerHTML = '';
  numberDisplay.textContent = '---';
  updateStatus();
}

function startDraw() {
  const countInput = parseInt(document.getElementById('count').value);
  if (!seats.length && !finished) {
    if (!countInput || countInput <= 0) {
      alert('人数を正しく入力してください');
      return;
    }
    initSeats(countInput);
  }
  if (finished) return;

  stopBtn.style.display = 'inline-block';
  startBtn.disabled = true;
  resetBtn.disabled = true;

  if (!muted) {
    try { drum.currentTime = 0; drum.play(); } catch(e) {}
  }

  intervalId = setInterval(() => {
    currentNumber = seats[Math.floor(Math.random() * seats.length)];
    numberDisplay.textContent = currentNumber;
  }, 50);
}

function stopDraw() {
  if (!intervalId) return;
  clearInterval(intervalId);
  intervalId = null;

  drum.pause();
  seats = seats.filter(num => num !== currentNumber);
  resultsDiv.innerHTML += `<div>→ 席番号 ${currentNumber} 決定！</div>`;

  if (!muted) {
    try { fanfare.currentTime = 0; fanfare.play(); } catch(e) {}
  }

  stopBtn.style.display = 'none';
  startBtn.disabled = false;
  resetBtn.disabled = false;
  numberDisplay.textContent = '---';

  if (seats.length === 0) {
    finished = true;
    startBtn.disabled = true;
    stopBtn.disabled = true;
    updateStatus();
    return;
  }
  updateStatus();
}

function resetAll() {
  if (intervalId) { clearInterval(intervalId); intervalId = null; }
  drum.pause();
  fanfare.pause();
  seats = [];
  currentNumber = null;
  finished = false;
  numberDisplay.textContent = '---';
  resultsDiv.innerHTML = '';
  startBtn.disabled = false;
  stopBtn.disabled = false;
  stopBtn.style.display = 'none';
  updateStatus();
}

function toggleMute() {
  muted = !muted;
  muteBtn.textContent = muted ? '🔇 ミュート解除' : '🔊 ミュート';
  muteBtn.setAttribute('aria-pressed', String(muted));
  if (muted) { drum.pause(); fanfare.pause(); }
}

async function checkUpdate() {
  if (!('serviceWorker' in navigator)) return;
  const reg = await navigator.serviceWorker.getRegistration();
  if (!reg) return;
  await reg.update();
  if (reg.waiting) {
    reg.waiting.postMessage({type:'SKIP_WAITING'});
  } else if (reg.installing) {
    reg.installing.addEventListener('statechange', () => {
      if (reg.waiting) reg.waiting.postMessage({type:'SKIP_WAITING'});
    });
  }
}

navigator.serviceWorker.addEventListener('controllerchange', () => {
  window.location.reload();
});

startBtn.addEventListener('click', startDraw);
stopBtn.addEventListener('click', stopDraw);
resetBtn.addEventListener('click', resetAll);
muteBtn.addEventListener('click', toggleMute);
updateBtn.addEventListener('click', checkUpdate);

if ('serviceWorker' in navigator) {
  navigator.serviceWorker.register('./service-worker.js', { scope: './' })
    .then(() => console.log('SW registered'));
}
</script>
</body>
</html>
